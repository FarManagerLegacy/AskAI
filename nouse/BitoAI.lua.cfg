name = utf8.char(0xf121).." Bito Alpha"
url = "https://alpha.bito.ai/bitoai/home"

local U = ...
if not U.restapi then return end
exe = true

historyName = name

return function (session, stream, context, authorization, bitoUserId, wsId, outputLanguage)
  local client = U.restapi.BasicSSE(nil, "https://bitoai.bito.ai/ai/v2", {
    origin="https://alpha.bito.ai",
    authorization=authorization,--invCode
    --["x-clientinfo"]="Win32 Gecko 20030107#Chrome#3.3#db6fa4f9-7e8c-ca07-ab55-2bce37129ebb#Chrome",
    --uId
  })
  function client:is_valid (parsed)
    return parsed.choices
  end
  function client:is_valid_final (parsed)
    return parsed.content
  end
  local function getMsgText (data)
    return data.message or data.response
  end
  local history = session and U.getHistory(historyName) or {}
  --local function uuid() return win.Uuid(win.Uuid()) end
  local data = {
    prompt=context,
    bitoUserId=U.number(bitoUserId),
    --email=email,
    ideName="Chrome",
    outputLanguage=outputLanguage,
    --requestId=uuid()
    --sessionId=uuid()
    stream=U.boolean(stream),
    --uId==uuid(),
    wsId=U.number(wsId),
    context=history[1] and history or nil,
    aiModelType="ADVANCED",
  }
  return function (cb)
    local chunks = {}
    local function ln() return chunks[1] and "\n\n" or "" end
    local response,meta = client:generate("/chat/", data, function (chunk,err,extra)
      if err then
        cb(ln()); chunks[1] = chunks[1] or ""
        if type(extra)=="string" then
          err = err.." "..extra
        elseif type(extra)=="table" then
          return cb(U.formatErrMsg({ statusline=err, data=extra }, "\n", getMsgText).."\n")
        end
        return cb("Error: "..err)
      end
      local candidate = assert(chunk.choices[1])
      table.insert(chunks, assert(candidate.text))
      cb(candidate.text, chunk.model)
      if U.utils.check"Esc" then error("interrupted", 0) end
    end)

    if response==U.restapi.STREAMED then
      table.insert(history, {question=context, answer=table.concat(chunks)})
    elseif response then
      local parts = {}
      for _,part in ipairs(response.content) do
        if part.type=="text" then
          cb(part.text)
          table.insert(parts, part.text)
        else
          cb(ln()..U.formatErrMsg(part,"\n\n",function()end))
        end
      end
      table.insert(history, {role="assistant", answer=table.concat(parts)})
    else
      if not chunks[1] then
        meta.data = meta.data or response
        cb(ln()..U.formatErrMsg(meta,"\n\n",getMsgText))
      end
    end
    cb()
  end
end
