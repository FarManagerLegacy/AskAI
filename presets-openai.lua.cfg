name = "presets"
local applyParams = _import "lua-openai.lua.cfg"

local cfgpath = (...).cfgpath
local list = {}
far.RecursiveSearch(cfgpath, "*.preset", function (item)
  table.insert(list, item.FileName)
end)

predefined = {
  preset=list
}

local function mergeLocalsTo (args, subst)
  local level = 2
  for i=1,debug.getinfo(level, "u").nparams do
    local name,value = debug.getlocal(level, i)
    if value~=nil then
      args[subst[name] or name] = value
    end
  end
  return args
end

return function (session, stream, context, preset, apikey_, model_, temperature, role, headers) --luacheck: ignore 212
  local _,args = _import(preset, setmetatable({}, {__index=_G}))
  return applyParams(mergeLocalsTo(args, {
    apikey_ = "apikey",
    model_ = "model",
  }))
end
