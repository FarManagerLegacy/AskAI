name = "presets"
local applyParams, getModels = _import "openai.lua.cfg"
if not exe then return end

local cfgpath = (...).cfgpath
local list = {}
far.RecursiveSearch(cfgpath, "*.preset", function (item)
  table.insert(list, item.FileName)
end)

predefined = {
  preset=list
}

sets = {
  preset = {"apikey", "model", "headers"}
}

hidden = nil

local function mergeLocalsTo (args)
  local level = 2
  for i=1,debug.getinfo(level, "u").nparams do
    local name,value = debug.getlocal(level, i)
    if value~=nil then
      args[name] = value
    end
  end
  return args
end

return function (session, stream, context, preset, apikey, model, temperature, role, headers) --luacheck: ignore 212
  local args = setmetatable({}, {__index=_G})
  _import(assert(preset, "preset required"), args)
  return applyParams(mergeLocalsTo(args))
end,

-- getModels
function (data)
  if pcall(_import, data.preset, setmetatable(data, {__index=_G})) then
    if data.apibase=="" then data.apibase = nil end
    return getModels(setmetatable(data, nil))
  end
end
