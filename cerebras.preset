--https://cloud.cerebras.ai/
--https://inference-docs.cerebras.ai/support/change-log
--Try chat: from https://chat.cerebras.ai/

--https://inference-docs.cerebras.ai/
apibase="https://api.cerebras.ai/v1"

local Common = ...
apikey=win.GetEnv"CEREBRAS_API_KEY" or function (oldkey) -- get demo key
  if not oldkey:match"^demo%-" then return end

  local id = win.Uuid"75297D85-1DAF-46AF-A9C4-1B66E959CAFB"
  local COOKIENAME = "authjs.session-token"
  local cookies
  repeat
    cookies = far.InputBox(id, "Cerebras preset", "Enter cookies:", "AskAI/cerebras.preset/cookies")
    if not cookies then
      return -- Esc
    elseif #cookies==36 then --uuid
      cookies = COOKIENAME.."="..cookies
      break
    elseif cookies:find(COOKIENAME,1,"plain") then
      break
    end
    far.Message(('"%s" cookie required'):format(COOKIENAME),"Cerebras preset",nil,"wl")
  until false

  local ltn12 = require"ltn12"
  local acc = {}
  local _, status_code, _, status_line = assert(require"ssl.https".request {
    method="POST",
    url="https://chat.cerebras.ai/api/graphql",
    headers={["content-type"]="application/json", cookie=cookies},
    sink=ltn12.sink.table(acc),
    source=ltn12.source.string[[{
      "operationName": "GetMyDemoApiKey",
      "variables": {},
      "query": "query GetMyDemoApiKey {\n  GetMyDemoApiKey\n}"
    }]]
  })
  local resp = table.concat(acc)
  if status_code~=200 then
    error(("%s\n\1\n%s"):format(status_line or status_code, resp))
  end

  resp = assert(Common.json.decode(resp))
  if resp.errors then
    far.Message(resp.errors[1].message,"Cerebras preset",nil,"wl")
    return
  end
  return resp.data.GetMyDemoApiKey
end

model="gpt-oss-120b"
