--Temporary demoApiKey from website can be used
--gpt-oss, GLM, Llama, Qwen

--https://cloud.cerebras.ai/
--https://inference-docs.cerebras.ai/support/change-log
--Try chat: from https://chat.cerebras.ai/

--https://inference-docs.cerebras.ai/
apibase="https://api.cerebras.ai/v1"

apikey=win.GetEnv"CEREBRAS_API_KEY" or "set CEREBRAS_API_KEY env variable!"

model="gpt-oss-120b"

--https://inference-docs.cerebras.ai/capabilities/reasoning#reasoning-with-z-ai-glm-4-6
--https://inference-docs.cerebras.ai/resources/openai#passing-non-standard-parameters
extra_body={
  "disable_reasoning: false",
  "disable_reasoning: true",
}

apidef=[[
class Cerebras extends OpenAI
  @@._cache = {}
  class Auth extends Plain
    headers: "User-Agent": ":"
    api_base: "https://chat.cerebras.ai/api"
    expires_in: 600
    GetMyDemoApiKey: '{"operationName":"GetMyDemoApiKey","variables":{},"query":"query GetMyDemoApiKey {\\n  GetMyDemoApiKey\\n}"}'

    new: (@session_token) => @headers.cookie = "authjs.session-token=#{@session_token}"

    refresh: (expiry) =>
      curtime = os.time!
      unless expiry and expiry>curtime
        with data = assert @request "/graphql", @GetMyDemoApiKey, "content-type": "application/json"
          assert data and data~=json.null, "Wrong authjs.session-token value"
          error .errors[1].message if .errors
          return {
            exp:curtime + @expires_in
            demoApiKey:assert .data and .data.GetMyDemoApiKey, "Unexpected response"
          }

  api_base: "https://api.cerebras.ai/v1"

  new: (@api_key, @api_base, @cache) =>
    if @api_key and #@api_key==36 and win.Uuid @api_key
      session_token = @api_key
      @auth = Auth session_token
      data = @@._cache[session_token]
      unless data
        data = @auth\refresh!
        @@._cache[session_token] = data
      { demoApiKey:@api_key, exp:@exp } = data

  request: (...) =>
    if data = @auth and @auth\refresh @exp
      { demoApiKey:@api_key, exp:@exp } = data
    super ...
]]
