name = "Antigravity API"

local U = ...
if not U.restapi then return end

local auth_profile = {
  client_id="1071006060591-tmhssin2h21lcre235vtolojh4g403ep.apps.googleusercontent.com",
  client_secret="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",
}
assert(require "moonscript".loadstring([[
api.GoogleAntigravity or= class extends api.GoogleInternal
  with @.__base do for k,v in pairs profile
    [k] = v
  api_base: "https://daily-cloudcode-pa.sandbox.googleapis.com/v1internal"
  headers: "User-Agent": "antigravity/1.11.9 windows/amd64" --https://antigravity.google/changelog
]], "GoogleAntigravity moon src",nil,setmetatable({api=U.restapi, profile=auth_profile},{__index=_G}),nil))()

local applyParams = _import("Gemini.lua.cfg", nil, U.restapi.GoogleAntigravity)
if not applyParams then return end

url = "https://antigravity.google/"
predefined.api_base = nil --"https://daily-cloudcode-pa.sandbox.googleapis.com/v1internal"
predefined.api_key = nil
predefined.model = "gemini-2.5-flash"

local function getMsgText (data)
  local msg = data.message or data.error or data
  msg = msg.error or msg
  return msg.message or msg
end

return applyParams,

--https://antigravity.google/docs/models
--https://antigravity.google/docs/plans -- rate limits
function (data) -- getModels
  local client = U.restapi.GoogleAntigravity(data.apikey, data.api_base)
  client.formatErr = function (errMeta)
    return U.formatErrMsg(errMeta,"\n\1\n",getMsgText)
  end
  local models = assert(client:models())
  models.filterFn = function(model)
    return model.recommended
  end
  return models
end,

function () --authFn
  local _export = {json=U.json, openUrl=U.utils.openUrl}
  local getToken = U.utils.loadMoon("oauth_google.moon.1", _export) "oauth_google"
  local title,msg = "Authorization",nil
  return getToken(auth_profile, function(line)
    msg = msg and msg.."\n" or ""
    msg = msg..line
    far.Message(msg,title,"","l")
  end)
end
