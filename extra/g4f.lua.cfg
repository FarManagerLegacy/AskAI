name = "g4f (gpt4free)"
url = "https://github.com/xtekky/gpt4free/releases"
exe = "g4f"
--https://github.com/gpt4free/g4f.dev/blob/main/docs/requirements.md
--https://github.com/gpt4free/g4f.dev/blob/main/docs/config.md
--https://g4f.dev/docs/providers-and-models

local CONFIG_HOME = _isWindows and _env"APPDATA" or _env"HOME".."/.config"
sessionFile = _pathjoin(CONFIG_HOME, "g4f", "conversation.json")
--clearSession = exe.." client --clear-history"

predefined = {
  extra={
    "",
    "--debug",
  }
}

return function (session, model, provider, role, max_messages, extra)
  return _pipeOut(exe, _context) {
    "client",
    session and "" or "--no-config",
    _optional("--model", model),
    _optional("--provider", provider),
    _optional("--instructions", role),
    _optional("--max-messages", max_messages),
    --_optional("--cookies-dir", cookies_dir), --default: $CONFIG_HOME/g4f/cookies
    --'--conversation-file "..."',
    _optional(extra),
  }
end,

_readLines(exe.." client --help", function(line,state,cb)
  line = line:match"^%s+(.+)"
  if line then
    if not state.started then
      line = line:match("^Provider to use: (.+)")
      state.started = line
    end
    if state.started then -- in providers section
      if line and line:match"^[^-]" then
        for provider in line:gmatch("([^,]+)") do
          provider = provider:match("^%s*(.-)%s*$")
          if provider and provider~="" then
            cb(provider)
          end
        end
      else
        state.finished = true
      end
    end
  end
end)
