name = "Gemini CLI API"

local U = ...
if not U.restapi then return end

local auth_profile = {
  client_id="681255809395-oo8ft2oprdrnp9e3aqf6av3hmdib135j.apps.googleusercontent.com",
  client_secret="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",
  --https://github.com/google-gemini/gemini-cli/pull/14865
  headers={ ["User-Agent"]="GeminiCLI/0.20.0/gemini-pro (windows; amd64)" }, --npm view @google/gemini-cli version
}
local applyParams = _import("Gemini.lua.cfg", nil, U.restapi.GoogleInternal:class("GeminiCLI", auth_profile))
if not applyParams then return end

url = "https://github.com/google-gemini/gemini-cli#option-1-login-with-google-oauth-login-using-your-google-account"
predefined.api_base = {
  "",
  "https://autopush-cloudcode-pa.sandbox.googleapis.com/v1internal",
  "https://daily-cloudcode-pa.sandbox.googleapis.com/v1internal",
  "https://cloudcode-pa.googleapis.com/v1internal",
}

predefined.api_key = nil
local HOME = win.GetEnv(_isWindows and "USERPROFILE" or "HOME")
local oauth_creds = _pathjoin(HOME, ".gemini", "oauth_creds.json")
if win.GetFileInfo(oauth_creds) then
  pcall(function()
    for line in io.lines(oauth_creds) do
      local refresh_token = line:match'"refresh_token": "(.-)"'
      if refresh_token then
        predefined.api_key = refresh_token
        break
      end
    end
  end)
end

--https://github.com/google-gemini/gemini-cli/blob/main/packages/core/src/config/models.ts
--https://developers.google.com/gemini-code-assist/resources/quotas#quotas-for-agent-mode-gemini-cli
--https://github.com/google-gemini/gemini-cli/blob/main/docs/quota-and-pricing.md#log-in-with-google-gemini-code-assist-for-individuals
predefined.model = {
  "gemini-2.5-flash",
  "gemini-2.5-flash-lite",
  "gemini-2.5-pro",
  "gemini-2.5-pro-preview-06-05",
  --"gemini-3-pro-preview",
}

return applyParams,

nil, --getModels

function () --authFn
  local _export = {json=U.json, openUrl=U.utils.openUrl}
  local getToken = U.utils.loadMoon("oauth_google.moon.1", _export) "oauth_google"
  local title,msg = "Authorization",nil
  return getToken(auth_profile, function(line)
    msg = msg and msg.."\n" or ""
    msg = msg..line
    far.Message(msg,title,"","l")
  end)
end
