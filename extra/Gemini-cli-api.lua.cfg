name = "Gemini CLI API"

local U = ...
if not U.restapi then return end

local auth_profile = {
  client_id="681255809395-oo8ft2oprdrnp9e3aqf6av3hmdib135j.apps.googleusercontent.com",
  client_secret="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",
}
assert(require "moonscript".loadstring([[
api.GoogleGeminiCLI or= class extends api.GoogleInternal
  with @.__base do for k,v in pairs profile
    [k] = v
  api_base: "https://cloudcode-pa.googleapis.com/v1internal"
]], "GoogleGeminiCLI moon src",nil,setmetatable({api=U.restapi, profile=auth_profile},{__index=_G}),nil))()

local applyParams = _import("Gemini.lua.cfg", nil, U.restapi.GoogleGeminiCLI)
if not applyParams then return end

url = "https://github.com/google-gemini/gemini-cli#option-1-login-with-google-oauth-login-using-your-google-account"
predefined.api_base = nil --"https://cloudcode-pa.googleapis.com/v1internal"

predefined.api_key = nil
local HOME = win.GetEnv(_isWindows and "USERPROFILE" or "HOME")
local oauth_creds = _pathjoin(HOME, ".gemini", "oauth_creds.json")
if win.GetFileInfo(oauth_creds) then
  pcall(function()
    for line in io.lines(oauth_creds) do
      local refresh_token = line:match'"refresh_token": "(.-)"'
      if refresh_token then
        predefined.api_key = refresh_token
        break
      end
    end
  end)
end

predefined.model = {
  "gemini-2.5-flash",
  "gemini-2.5-flash-preview-05-20",

  "gemini-2.5-flash-lite",
  "gemini-2.5-flash-lite-preview-06-17",

  "gemini-2.5-pro",
}

return applyParams,

nil, --getModels

function () --authFn
  local _export = {json=U.json, openUrl=U.utils.openUrl}
  local getToken = U.utils.loadMoon("oauth_google.moon.1", _export) "oauth_google"
  local title,msg = "Authorization",nil
  return getToken(auth_profile, function(line)
    msg = msg and msg.."\n" or ""
    msg = msg..line
    far.Message(msg,title,"","l")
  end)
end
