name = "Copilot CLI"
--https://github.com/features/copilot/cli
--https://docs.github.com/copilot/how-tos/use-copilot-agents/use-copilot-cli
--Limits: https://docs.github.com/en/copilot/get-started/plans#comparing-copilot-plans
url = "https://github.com/github/copilot-cli"
--https://github.com/github/copilot-cli/releases
-- or
--winget install GitHub.Copilot
-- or
--npm install -g @github/copilot
exe = "copilot"

--local CONFIG_HOME = _isWindows and _env"USERPROFILE" or _env"XDG_CONFIG_HOME" or _env"HOME"
--config = _pathjoin(CONFIG_HOME, ".copilot", "config.json")

env = {
  token="COPILOT_GITHUB_TOKEN",
}

predefined = {
  model = {
    "gpt-5-mini",
    "claude-sonnet-4.5",--default
  },
  args = {
    "--silent --disable-builtin-mcps --available-tools none --log-level warning",
    "--allow-all-tools",
    "--log-level all",
  }
}

return function (session, stream, model, role, yolo, dir, args)
  return _pipeOut(exe, _context) {
    session and "--continue" or "",
    stream and "" or "--stream off",
    _optional("--model", model),
    _optional("--prompt", role),
    yolo and "--yolo" or "",
    _optional("--add-dir", dir),
    "--no-auto-update",
    _optional(args),
    '--available-tools none',
    "--disable-builtin-mcps",
  }
end,

--getModels
_readLines(exe.." help config", function(line,state)
  if state.started then
    if #line==0 then
      state.finished = true
    else
      return line:match'%- "(.-)"'
    end
  else
    state.started = line:match"^  `model`:"
  end
end)
