name = "ChatGPT CLI"
url = "https://github.com/kardolus/chatgpt-cli/releases"
--curl -L -o chatgpt-cli https://github.com/kardolus/chatgpt-cli/releases/latest/download/chatgpt-linux-amd64 && chmod +x chatgpt-cli && sudo mv chatgpt-cli /usr/local/bin/
exe = "chatgpt-cli" -- rename from chatgpt-windows-amd64.exe or whatever

local HOME = _isWindows and _env"USERPROFILE" or _env"HOME"
local configdir = _pathjoin(HOME, ".chatgpt-cli")
config = _pathjoin(configdir, "config.yaml")

sessionFile = _pathjoin(configdir, "history", "%s.json")
clearSession = exe.." --clear-history --thread %s>nul"

env = {
  apikey = "OPENAI_API_KEY",
}

sets = {
  apibase = {"apikey", "model"}
}

predefined = {
  effort={"", "low", "medium", "high"},
  target={""}
}
far.RecursiveSearch(configdir, "config.*.yaml", function(item)
  table.insert(predefined.target, item.FileName:match"config%.(.-)%.yaml")
end)


local function _boolean (key, value)
  return value=="true" and key or ""
end

return function (session, stream, apibase, apikey, target, model, context_window, max_tokens,
                 temperature, top_p, frequency_penalty, presence_penalty, effort, role,
                 debug, seed, track_token_usage)
  local args = {
    session and "--thread "..session or "--omit-history",
    stream and "" or "--query",
    _optional("--context-window", context_window),
    _optional("--effort", effort),
    _boolean("--debug", debug),
    _optional("--frequency-penalty", frequency_penalty),
    _optional("--max-tokens", max_tokens),
    _optional("--model", model),
    _optional("--presence-penalty", presence_penalty),
    _optional("--role", role),
    _optional("--seed", seed),
    _optional("--target", target),
    _optional("--temperature", temperature),
    _optional("--top-p", top_p),
    _boolean("--track-token-usage", track_token_usage),
  }
  if not target then
    args[#args+1] = _optional("--url", apibase)
    args[#args+1] = _optional("--api-key", apikey)
    args[#args+1] = apibase and "--completions-path /chat/completions"
  end
  return _pipeOut(exe, _context)(args)
end,

--getModels
_readLines(function (data)
  if data.target then
    return table.concat({ exe, "--list-models", "--target", data.target, }, " ")
  else
    return table.concat({ exe,
      "--list-models",
      _optional("--url", data.apibase),
      _optional("--api-key", data.apikey),
      data.apibase and "--models-path /models" or "",
    }, " ")
  end
end, function (line)
  return line:match"^[-*] (.+)"
end)
