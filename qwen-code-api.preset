-- 2,000 requests per day with no token limits
-- 60 requests per minute rate limit
-- https://qwenlm.github.io/qwen-code-docs/en/users/configuration/auth/#option-1-qwen-oauth-recommended--free-
-- https://github.com/QwenLM/qwen-code

apibase="https://portal.qwen.ai/v1"

local Common = ...
local key_name = "AskAI - qwen-code-api.preset"
apikey=function (cur)
  if cur~="" and mf.mload("jd", key_name) then
    return
  end
  local _export = {json=Common.json, openUrl=Common.utils.openUrl}
  local oauth = Common.utils.loadMoon("oauth_qwen.moon.1", _export) "oauth_qwen"
  local title,msg = "Authorization", "Waiting..."
  local data = oauth(function(url) msg = url end, function(time)
    far.Message(msg, title..": "..time, "")
  end)
  actl.RedrawAll()
  if data then
    data.exp = data.expiry_date / 1000
    data.expiry_date, data.resource_url, data.token_type = nil,nil,nil
    mf.msave("jd", key_name, data)
    return "[Authorized]"
  end
end

--https://github.com/QwenLM/qwen-code/blob/main/packages/core/src/models/constants.ts#L102
model={
  --"qwen3-coder-plus",
  "coder-model",  --qwen3-coder-plus-2025-09-23
  "vision-model", --qwen3-vl-plus-2025-09-23
}
modelsMeta="none"

apidef=[[
class QwenCode extends OpenAI
  userAgent = "QwenCode/0.7.1 (windows; amd64)", --npm view @qwen-code/qwen-code version
  class OAuth2 extends Plain
    headers:
      "User-Agent": userAgent
      "Content-Type": "application/x-www-form-urlencoded"
    api_base: "https://chat.qwen.ai/api/v1/oauth2"

    new: (client_id) =>
      @payload = "client_id=#{client_id}&grant_type=refresh_token&refresh_token="

    refresh: (data) =>
      curtime = os.time!
      unless data.exp>curtime
        data, meta = @request "POST", "/token", @payload..data.refresh_token
        with assert data or meta.data, meta
          error .error_description if .error
          error meta unless .status=="success"
          .exp = .expires_in + curtime
          .expires_in, .resource_url, .scope, .status, .token_type = nil

  key_name: "AskAI - qwen-code-api.preset"
  client_id: "f0304373b74a44d2b584a3fb70ca9e56"
  headers: "User-Agent": userAgent
  api_base: "https://portal.qwen.ai/v1"

  new: (@refresh_token, @api_base) =>
    data = assert mf.mload("jd", @key_name), "Authorization required"
    @auth = OAuth2 @client_id
    @api_key = data.access_token

  request: (...) =>
    if data = @auth\refresh mf.mload "jd", @key_name
      mf.msave "jd", @key_name, data
      @api_key = data.access_token
    super ...
]]
