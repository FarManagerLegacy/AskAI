url = "https://github.com/efugier/smartcat/releases"
name = "smartcat"
exe = "smartcat" -- rename sc.exe

local function getConfigHome ()
  return _isWindows and win.GetEnv"USERPROFILE" or win.GetEnv"HOME".."/.config"
end
local config_dir = win.GetEnv"SMARTCAT_CONFIG_PATH" or _pathjoin(getConfigHome(), ".config", "smartcat")
config = _pathjoin(config_dir, ".api_configs.toml")
sessionFile = _pathjoin(config_dir, "conversation.toml")

sets = {api = {"model"}}

local function getSections (filename)
  local file = assert(io.open(filename))
  local list = {}
  for line in file:lines() do
    table.insert(list, line:match"%[(%w+)%]")
  end
  file:close()
  return list
end

local success,templates = pcall(getSections, _pathjoin(config_dir, "prompts.toml"))
templates = success and templates or {}
table.insert(templates, 1, "")
predefined = { template=templates }

return function (session, template, api, model, temperature, char_limit, extra)
  return _pipeOut(exe, _context) {
    _optional(template),
    session and win.GetFileAttr(sessionFile) and "--extend-conversation" or "",
    _optional("--api", api),
    _optional("--model", model),
    _optional("--temperature", temperature),
    _optional("--char-limit", char_limit),
    _optional(extra)
  }
end,

--getModels
function () return getSections(config), "api" end
